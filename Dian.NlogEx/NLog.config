<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.nlog-project.org/schemas/NLog.xsd NLog.xsd"
      autoReload="true"
      throwExceptions="true"
      internalLogLevel="Off" internalLogFile="c:\nlog-internal.log" >

  <extensions>
    <add assembly="NLog.Targets.ElasticSearch"/>
  </extensions>
  
  <variable name="logDirectory" value="${basedir}/logs/"/>

  <targets>
    
    <target name="TargetDebugView" xsi:type="OutputDebugString"
            layout="${longdate} ${uppercase:${level}} ${message:withException=false} ${newline} ${stacktrace}"/>

    <target name="TargetFile" xsi:type="File"
              fileName="${logDirectory}/${logger}-${shortdate}.txt"
              layout="${longdate} ${uppercase:${level}}: ${message:withException=false} ${exception:format=ToString,StackTrace,method:maxInnerExceptionLevel=5:innerFormat=ToString}"
              archiveFileName="${logDirectory}/archives/log.{#}.zip"
              archiveEvery="Day"
              archiveNumbering="Rolling"
              maxArchiveFiles="7"
              enableArchiveFileCompression="true" />

    <!-- 错误日志-->
    <target name="elastic-normal" xsi:type="ElasticSearch" uri="http://112.124.117.107:32769/"  index="devlogging-1" documentType="Layout">
      <field name="level" layout="${uppercase:${level}}"/>
      <field name="message" layout="${message:withException=false}" />
      <field name="exception" layout="${exception}" />
      <field name="stacktrace" layout="${stacktrace}"/>
      <field name="host" layout="${machinename}"/>
      <!--<field name="platform" layout=${哪个平台}/>
      <field name="module" layout=${模块名字}/>
      <field name="parameter" layout=${参数及值}/>-->
    </target>
    
    <!-- 用户访问日志 -->
    <!--<target name="elastic-user-visit" xsi:type="ElasticSearch" uri="http://121.43.147.83:9200/"  index="devlogging-2" documentType="Layout">
      <field name="level" layout="${uppercase:${level}}"/>
      <field name="platform" layout=${哪个平台}/>
      <field name="host" layout="${machinename}"/>
      <field name="clientIp" layout="${event-context:item=clientIp}"/>
      <field name="duration" layout=${本次用时(毫秒)}/>
      <field name="screen" layout=${屏幕尺寸}/>
      <field name="verb" layout=${POST/GET/DELETE...}/>
      <field name="requestUrl" layout="${event-context:item=requestUrl}"/>
      <field name="requestParameter" layout="${event-context:item=requestParameter}"/>
      <field name="requestBody" layout="${event-context:item=requestBody}"/>
      <field name="statusCode" layout=${返回的状态码}/>
    </target>-->

    <!-- 异步 -->
    <target xsi:type="AsyncWrapper" name="TargetAsyncFile" queueLimit="50">
      <target-ref name="TargetFile"/>
    </target>
    <!--
    <target name="elastic" xsi:type="BufferingWrapper" flushTimeout="5000">
    </target>
    <wrapper-target xsi:type="BufferingWrapper" name="TargetAsyncElastic-normal" queueLimit="50">
      <target-ref name="elastic-normal"/>
    </wrapper-target>
    -->

  </targets>

  <rules>
    <logger name="*" minlevel="Trace" writeTo="TargetDebugView"/>
    <logger name="*" minlevel="Error" writeTo="TargetAsyncFile"/>
    <logger name="*" minlevel="Error" writeTo="elastic-normal"/>
    <!--<logger name="*" minlevel="Warn" writeTo="TargetAsyncElastic-normal" />-->
    <!--<logger name="*" minlevel="Trace" writeTo="elastic-user-visit" />-->
  </rules>
</nlog>

<!--${iis-site-name}-->